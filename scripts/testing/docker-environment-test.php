<?php
/**
 * BlackCnote Docker Environment Test Script
 * 
 * This script tests all components of the Docker environment
 * to ensure everything is working correctly.
 */

declare(strict_types=1);

class DockerEnvironmentTester {
    private array $results = [];
    private array $errors = [];
    private array $warnings = [];

    public function runAllTests(): void {
        echo "üê≥ BlackCnote Docker Environment Test\n";
        echo "=====================================\n\n";

        $this->testDockerServices();
        $this->testWordPressConfiguration();
        $this->testDatabaseConnection();
        $this->testRedisConnection();
        $this->testFileSystem();
        $this->testNetworkConnectivity();
        $this->testDevelopmentTools();
        $this->testSecuritySettings();

        $this->displayResults();
    }

    private function testDockerServices(): void {
        echo "1. Testing Docker Services...\n";
        
        $services = [
            'wordpress' => 'http://localhost:8888/blackcnote',
            'react-app' => 'http://localhost:5174',
            'phpmyadmin' => 'http://localhost:8080',
            'mailhog' => 'http://localhost:8025',
            'redis-commander' => 'http://localhost:8081'
        ];

        foreach ($services as $service => $url) {
            $this->testService($service, $url);
        }
    }

    private function testService(string $service, string $url): void {
        $context = stream_context_create([
            'http' => [
                'timeout' => 5,
                'method' => 'GET'
            ]
        ]);

        $response = @file_get_contents($url, false, $context);
        
        if ($response !== false) {
            $this->results[$service] = '‚úÖ Running';
            echo "   ‚úÖ $service: Running\n";
        } else {
            $this->errors[$service] = '‚ùå Not accessible';
            echo "   ‚ùå $service: Not accessible\n";
        }
    }

    private function testWordPressConfiguration(): void {
        echo "\n2. Testing WordPress Configuration...\n";
        
        // Test wp-config.php
        if (file_exists('blackcnote/wp-config.php')) {
            $this->results['wp-config'] = '‚úÖ Exists';
            echo "   ‚úÖ wp-config.php: Exists\n";
            
            // Check Docker-specific settings
            $config = file_get_contents('blackcnote/wp-config.php');
            
            if (strpos($config, "DB_HOST', 'mysql'") !== false) {
                $this->results['db-host'] = '‚úÖ Configured for Docker';
                echo "   ‚úÖ Database host: Configured for Docker\n";
            } else {
                $this->errors['db-host'] = '‚ùå Not configured for Docker';
                echo "   ‚ùå Database host: Not configured for Docker\n";
            }
            
            if (strpos($config, "WP_HOME', 'http://localhost:8888/blackcnote'") !== false) {
                $this->results['wp-urls'] = '‚úÖ Configured for Docker';
                echo "   ‚úÖ WordPress URLs: Configured for Docker\n";
            } else {
                $this->errors['wp-urls'] = '‚ùå Not configured for Docker';
                echo "   ‚ùå WordPress URLs: Not configured for Docker\n";
            }
        } else {
            $this->errors['wp-config'] = '‚ùå Missing';
            echo "   ‚ùå wp-config.php: Missing\n";
        }
    }

    private function testDatabaseConnection(): void {
        echo "\n3. Testing Database Connection...\n";
        
        try {
            $pdo = new PDO(
                'mysql:host=localhost;port=3306;dbname=blackcnote',
                'root',
                'blackcnote_password',
                [PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION]
            );
            
            $this->results['database'] = '‚úÖ Connected';
            echo "   ‚úÖ Database: Connected successfully\n";
            
            // Test WordPress tables
            $stmt = $pdo->query("SHOW TABLES LIKE 'wp_%'");
            $tables = $stmt->fetchAll(PDO::FETCH_COLUMN);
            
            if (count($tables) > 0) {
                $this->results['wp-tables'] = '‚úÖ WordPress tables exist';
                echo "   ‚úÖ WordPress tables: " . count($tables) . " tables found\n";
            } else {
                $this->warnings['wp-tables'] = '‚ö†Ô∏è No WordPress tables found';
                echo "   ‚ö†Ô∏è WordPress tables: No tables found (may need installation)\n";
            }
            
        } catch (PDOException $e) {
            $this->errors['database'] = '‚ùå Connection failed: ' . $e->getMessage();
            echo "   ‚ùå Database: Connection failed\n";
        }
    }

    private function testRedisConnection(): void {
        echo "\n4. Testing Redis Connection...\n";
        
        if (extension_loaded('redis')) {
            try {
                $redis = new Redis();
                $redis->connect('localhost', 6379);
                
                if ($redis->ping() === '+PONG') {
                    $this->results['redis'] = '‚úÖ Connected';
                    echo "   ‚úÖ Redis: Connected successfully\n";
                } else {
                    $this->errors['redis'] = '‚ùå Ping failed';
                    echo "   ‚ùå Redis: Ping failed\n";
                }
            } catch (Exception $e) {
                $this->errors['redis'] = '‚ùå Connection failed: ' . $e->getMessage();
                echo "   ‚ùå Redis: Connection failed\n";
            }
        } else {
            $this->warnings['redis'] = '‚ö†Ô∏è Redis extension not loaded';
            echo "   ‚ö†Ô∏è Redis: Extension not loaded\n";
        }
    }

    private function testFileSystem(): void {
        echo "\n5. Testing File System...\n";
        
        $directories = [
            'blackcnote/wp-content/themes/blackcnote',
            'blackcnote/wp-content/plugins/blackcnote-hyiplab',
            'blackcnote/wp-content/uploads',
            'react-app/src',
            'config/nginx'
        ];
        
        foreach ($directories as $dir) {
            if (is_dir($dir)) {
                $this->results[$dir] = '‚úÖ Exists';
                echo "   ‚úÖ $dir: Exists\n";
            } else {
                $this->errors[$dir] = '‚ùå Missing';
                echo "   ‚ùå $dir: Missing\n";
            }
        }
        
        // Test file permissions
        if (is_writable('blackcnote/wp-content/uploads')) {
            $this->results['uploads-writable'] = '‚úÖ Writable';
            echo "   ‚úÖ Uploads directory: Writable\n";
        } else {
            $this->warnings['uploads-writable'] = '‚ö†Ô∏è Not writable';
            echo "   ‚ö†Ô∏è Uploads directory: Not writable\n";
        }
    }

    private function testNetworkConnectivity(): void {
        echo "\n6. Testing Network Connectivity...\n";
        
        $ports = [
            8888 => 'Nginx Proxy',
            5174 => 'React Dev Server',
            8080 => 'PHPMyAdmin',
            8025 => 'MailHog',
            8081 => 'Redis Commander',
            3306 => 'MySQL',
            6379 => 'Redis'
        ];
        
        foreach ($ports as $port => $service) {
            $connection = @fsockopen('localhost', $port, $errno, $errstr, 2);
            
            if ($connection) {
                $this->results["port-$port"] = '‚úÖ Open';
                echo "   ‚úÖ Port $port ($service): Open\n";
                fclose($connection);
            } else {
                $this->errors["port-$port"] = '‚ùå Closed';
                echo "   ‚ùå Port $port ($service): Closed\n";
            }
        }
    }

    private function testDevelopmentTools(): void {
        echo "\n7. Testing Development Tools...\n";
        
        // Test Docker Compose
        $output = shell_exec('docker-compose --version 2>&1');
        if (strpos($output, 'Docker Compose') !== false) {
            $this->results['docker-compose'] = '‚úÖ Available';
            echo "   ‚úÖ Docker Compose: Available\n";
        } else {
            $this->errors['docker-compose'] = '‚ùå Not available';
            echo "   ‚ùå Docker Compose: Not available\n";
        }
        
        // Test Docker
        $output = shell_exec('docker --version 2>&1');
        if (strpos($output, 'Docker version') !== false) {
            $this->results['docker'] = '‚úÖ Available';
            echo "   ‚úÖ Docker: Available\n";
        } else {
            $this->errors['docker'] = '‚ùå Not available';
            echo "   ‚ùå Docker: Not available\n";
        }
        
        // Test file watching
        if (file_exists('logs/file-changes.log')) {
            $this->results['file-watcher'] = '‚úÖ Active';
            echo "   ‚úÖ File Watcher: Active\n";
        } else {
            $this->warnings['file-watcher'] = '‚ö†Ô∏è Not active';
            echo "   ‚ö†Ô∏è File Watcher: Not active\n";
        }
    }

    private function testSecuritySettings(): void {
        echo "\n8. Testing Security Settings...\n";
        
        $config = file_get_contents('blackcnote/wp-config.php');
        
        $securityChecks = [
            'DISALLOW_FILE_EDIT' => 'File editing disabled',
            'DISALLOW_UNFILTERED_HTML' => 'Unfiltered HTML disabled',
            'WP_DEBUG' => 'Debug mode enabled (development)',
            'WP_DEBUG_LOG' => 'Debug logging enabled'
        ];
        
        foreach ($securityChecks as $constant => $description) {
            if (strpos($config, "define('$constant', true)") !== false) {
                $this->results[$constant] = '‚úÖ Enabled';
                echo "   ‚úÖ $description: Enabled\n";
            } else {
                $this->warnings[$constant] = '‚ö†Ô∏è Not enabled';
                echo "   ‚ö†Ô∏è $description: Not enabled\n";
            }
        }
    }

    private function displayResults(): void {
        echo "\n" . str_repeat("=", 50) . "\n";
        echo "TEST RESULTS SUMMARY\n";
        echo str_repeat("=", 50) . "\n\n";
        
        $totalTests = count($this->results) + count($this->errors) + count($this->warnings);
        $passedTests = count($this->results);
        $failedTests = count($this->errors);
        $warningTests = count($this->warnings);
        
        echo "Total Tests: $totalTests\n";
        echo "‚úÖ Passed: $passedTests\n";
        echo "‚ùå Failed: $failedTests\n";
        echo "‚ö†Ô∏è Warnings: $warningTests\n\n";
        
        if ($failedTests === 0) {
            echo "üéâ All critical tests passed! Docker environment is ready.\n\n";
        } else {
            echo "‚ö†Ô∏è Some tests failed. Please check the errors above.\n\n";
        }
        
        if (count($this->errors) > 0) {
            echo "‚ùå ERRORS:\n";
            foreach ($this->errors as $test => $message) {
                echo "   - $test: $message\n";
            }
            echo "\n";
        }
        
        if (count($this->warnings) > 0) {
            echo "‚ö†Ô∏è WARNINGS:\n";
            foreach ($this->warnings as $test => $message) {
                echo "   - $test: $message\n";
            }
            echo "\n";
        }
        
        echo "üåê Access URLs:\n";
        echo "   WordPress: http://localhost:8888/blackcnote\n";
        echo "   React App: http://localhost:5174\n";
        echo "   PHPMyAdmin: http://localhost:8080\n";
        echo "   MailHog: http://localhost:8025\n";
        echo "   Redis Commander: http://localhost:8081\n\n";
        
        echo "üìã Useful Commands:\n";
        echo "   View logs: docker-compose logs -f\n";
        echo "   Stop services: docker-compose down\n";
        echo "   Restart services: docker-compose restart\n";
        echo "   Update containers: docker-compose pull && docker-compose up -d\n";
    }
}

// Run the tests
$tester = new DockerEnvironmentTester();
$tester->runAllTests(); 